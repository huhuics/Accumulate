## 一、项目背景
中国人民银行公告(2013)第6号文件《支付机构客户备付金存管办法》第三章第二十七条规定：“不同支付机构的备付金银行之间不得办理客户备付金的划转”，禁止第三方机构互联。

移动支付转接清算平台是多方共享的移动支付公共清算平台，直接服务对象包括付款端（支付宝、微信）、收单端；间接服务对象包括商户、用户。以智能手机和POS机为载体，以二维码作为支付介质，拓展线下消费场景，为商业银行和第三方支付机构提供移动支付交易和资金清算服务。移动支付清算平台提供支付通道、集合对账、资金清算、技术对接、差错处理、运行维护等综合服务，减少付款端和收单端接入，降低维护支付清算服务的成本。

## 二、系统结构
移动支付清算平台包括付款端、收单端和转接清算端三大功能节点。一方面，平台提供付款端多种支付渠道接入，通过专线对接包括商业银行手机钱包、支付宝、微信支付、翼支付等大型第三方支付机构；另一方面，对接大型的持牌收单端，为其提供支付渠道接入服务、交易转接和资金清算服务。

**付款端：** 客户存放账户的企业，在移动平台中定位于客户的拓展方，包括支付宝、微信等。

**转接清算端：** 指结算中心移动支付清算平台，通过整合付款端及收单端资源，让两端资源充分优化配置。

**收单端：** 提供订单数据，在移动支付清算平台中定位于商户的拓展方，与商户签有协议，主要包括持牌的第三方收单机构。

## 三、优化点
### 1.头寸
头寸控制，每笔正向交易请求都需要增加收单机构头寸值，每笔负向交易（退款、撤销）都需要减少收单机构头寸值。系统原始的做法是将头寸保存在数据库，每笔交易都去读取数据的头寸值，通过数据库锁来控制头寸的并发修改。每天日切（0点）将头寸值归0，重新统计当天头寸。

第一次改进，是通过使用MQ，所有的头寸增加线程都作为生产者向MQ发送消息，发送头寸增加消息与交易的其它操作是同步的；消费者配置成一个线程，即通过MQ将并行改为串行。消费者每次取消息队列中的一条消息，再修改数据库的头寸表。通过上述优化，系统TPS增加一倍以上。

这次改进虽然增加了系统吞吐量，但是这种方式依然有优化的空间，比如消费者每次可以取多条消息，将需要增加的头寸在内存中累加再一次性写入数据表，以减少数据库访问次数。此外，头寸的减少是直接修改数据表的，没做任何优化。

第二次改进，使用Redis的分布式锁（setnx+getset）控制头寸值。头寸值不再存入数据库，而是常驻内存。头寸值的增加和交易的其它流程是异步的，即增加头寸的任务提交到线程池，再由异步线程去修改Redis中的头寸值。头寸的减少和交易的其它流程是同步的。通过这次优化，系统TPS在第一次优化后的基础上，增加了三倍以上。

### 2.对账
与付款端对账，即对比我方交易数据和付款端交易数据是否一致，主要是通过订单号对比订单的交易金额、状态等。系统原始做法是将付款端的对账文件（CSV文件，包含了所有付款端订单数据）解析并落入数据库，再在程序中查询数据库，把两方的数据放入内存中比对，并记录对账差错。这种方式在交易数据量较少时对账时间还能容忍，一旦数据量增加到百万量级，对账时间不能容忍。

> 遇到有一些比较难解决的问题的时候，我们可以尝试通过分析业务特点，通过**合理的设计**或者**将问题分解**来规避，如果硬要把时间花在解决问题本身，实际上不仅效率低下，而且也是一种浪费。

优化对账的时候，选择的思路就是绕过问题本身，结合业务特点合理设计。在对账过程中发现，99.9%的账单都是可以对平账的，极少数会对不平。那么在原来对账流程上加一个对账预处理，通过Oracle的merge into命令，在数据库端对付款端交易和我方交易进行比对，比对正确的账单标记为已对账。merge into是非常高效的，经过这个预处理，99.9%的数据被正确比对完，剩下只有极少数账单没有对平账。再查询出没有平账的账单进行差错处理，整个对账就此结束。

通过这个优化，三百万笔交易对账从原来的三小时，压缩至十五分钟。

